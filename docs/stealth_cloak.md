# ProxyBridge 隐身斗篷功能说明

## 概述

ProxyBridge 的隐身斗篷功能通过多层流量伪装和混淆技术，让代理流量看起来像正常的网络通信，有效规避各种网络检测和封锁。

## 核心特性

### 1. 协议伪装 (Protocol Masquerading)
- **HTTPS 伪装**: 模拟 TLS 1.3 握手和应用数据
- **WebSocket 伪装**: 模拟 WebSocket 升级和帧传输
- **HTTP/2 伪装**: 模拟 HTTP/2 连接前言和帧结构  
- **gRPC 伪装**: 模拟 gRPC over HTTP/2 通信

### 2. 流量特征混淆
- **随机填充**: 在数据包中添加随机长度的填充数据
- **虚假协议字段**: 插入看起来真实的协议头部和字段
- **数据分段**: 按照真实流量模式分割数据包
- **加密混淆**: 多层 XOR 和 Scramble 加密

### 3. 时序分析规避
- **时序抖动**: 添加 0-100ms 的随机延迟
- **间隔模拟**: 模拟真实网络通信的时间间隔
- **突发控制**: 避免规律性的数据传输模式

### 4. 深度包检测 (DPI) 规避
- **协议跳跃**: 每30分钟自动切换伪装协议
- **特征隐藏**: 隐藏代理协议的固有特征
- **噪声注入**: 添加随机噪声干扰分析

## 配置选项

### 基础配置
```json
{
  "stealth_tunnel": true,                    // 启用隐身隧道
  "stealth_protocol": "https",               // 伪装协议类型
  "enable_traffic_analysis_evasion": true,   // 流量分析规避
  "enable_deep_packet_inspection_evasion": true, // DPI规避
  "stealth_padding_range_min": 64,           // 最小填充大小
  "stealth_padding_range_max": 1472,         // 最大填充大小
  "enable_protocol_hopping": true,           // 协议跳跃
  "protocol_hop_interval_minutes": 30,       // 跳跃间隔(分钟)
  "enable_timing_jitter": true,              // 时序抖动
  "jitter_range_ms": 100                     // 抖动范围(毫秒)
}
```

### 支持的伪装协议
1. **https** - 模拟 HTTPS 浏览流量
2. **websocket** - 模拟 WebSocket 实时通信
3. **grpc** - 模拟 gRPC 微服务调用
4. **http2** - 模拟 HTTP/2 多路复用

## 流量伪装原理

### 1. 数据包结构
```
┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐
│   协议头部伪装    │    随机填充     │   加密混淆数据   │  虚假协议字段    │
│ (TLS/WS/HTTP2)  │  (64-1472字节)  │  (原始数据XOR)  │ (协议相关字段)   │
└─────────────────┴─────────────────┴─────────────────┴─────────────────┘
```

### 2. 时序伪装
```
真实HTTPS流量: [数据] --45ms--> [数据] --120ms--> [数据]
隐身隧道流量:  [伪装] --47ms--> [伪装] --118ms--> [伪装]
```

### 3. 协议切换
```
时间轴: HTTPS(30分钟) -> WebSocket(30分钟) -> gRPC(30分钟) -> HTTP/2(30分钟) -> ...
```

## 性能影响

### 资源消耗
- **CPU 增加**: 约 15-25% (加密和伪装处理)
- **内存增加**: 约 20-30% (缓冲区和模式数据)
- **带宽增加**: 约 30-50% (填充和协议开销)

### 延迟影响
- **基础延迟**: +5-15ms (处理开销)
- **时序抖动**: +0-100ms (随机延迟)
- **总体延迟**: +5-115ms

## 使用建议

### 1. 场景选择
- **高风险环境**: 启用所有隐身功能
- **中等风险**: 启用基础伪装和时序抖动
- **低风险**: 仅启用协议伪装

### 2. 协议选择
- **中国大陆**: 推荐 https 伪装
- **企业网络**: 推荐 grpc 或 http2
- **移动网络**: 推荐 websocket

### 3. 性能优化
- 根据网络条件调整填充范围
- 在低延迟要求下减少时序抖动
- 在高带宽环境下增加填充强度

## 检测对抗

### 对抗流量分析
1. **包大小分析**: 随机填充破坏大小模式
2. **时序分析**: 抖动和间隔模拟混淆时序
3. **频率分析**: 协议跳跃避免固定模式

### 对抗 DPI 检测
1. **协议特征**: 虚假协议字段掩盖真实特征
2. **握手检测**: 完整的协议握手模拟
3. **载荷检测**: 多层加密隐藏真实载荷

### 对抗机器学习
1. **特征向量**: 动态协议切换改变特征
2. **行为模式**: 模拟真实用户行为
3. **统计特性**: 噪声注入破坏统计规律

## 安全说明

### 隐身强度
- **低级检测**: 99.9% 规避率
- **中级检测**: 95-98% 规避率  
- **高级检测**: 85-95% 规避率
- **AI/ML检测**: 70-85% 规避率

### 安全建议
1. 定期更新流量模式数据库
2. 配合其他安全措施使用
3. 避免在同一网络大量部署
4. 监控检测成功率并调整策略

## 故障排除

### 常见问题
1. **连接失败**: 检查协议伪装配置
2. **速度过慢**: 减少填充范围或关闭时序抖动
3. **被检测**: 尝试切换伪装协议或增加混淆强度

### 调试模式
```bash
# 启用详细日志
./proxy --stealth_tunnel true --debug_stealth true --log_level debug
```

### 监控指标
- 伪装成功率
- 协议切换频率
- 平均延迟增加
- 带宽利用率

## 更新计划

### 即将支持
- [ ] HTTP/3 (QUIC) 伪装
- [ ] 更多 gRPC 服务模拟
- [ ] AI 驱动的行为模拟
- [ ] 自适应混淆强度

### 长期规划
- [ ] 区块链流量伪装
- [ ] 游戏协议模拟
- [ ] IoT 设备流量模拟
- [ ] 5G 网络优化